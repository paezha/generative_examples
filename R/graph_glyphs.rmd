# Generative text system based on graphs

```{r setup}
library(tidyverse)
library(ggforce)
library(ggraph)
library(tidygraph)
library(cowplot)

knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

set.seed(1)

```

```{r functions}
# generate glyph shapes by using networks
# https://en.wikipedia.org/wiki/Relative_neighborhood_graph


# draw n points in [0-1] in x and y
layout_square <- function(n = 7) {
  tibble(n=1:n, x=runif(n, -1, 1), y=runif(n, -1, 1)) 
}

# draw n points in a unit circle 
# https://mathworld.wolfram.com/DiskPointPicking.html
layout_ellipse <- function(n = 7, r = 1, a = -pi/6) {
  r = sqrt(runif(n, 0, r))
  theta = runif(n, 0, 2*pi)
  
  # scale and rotate layout
  layout <- tibble(
    n = 1:n,
    x0 = r * cos(theta),
    y0 = r * sin(theta)) %>% 
    mutate(x0 = x0 * 0.5) %>% 
    mutate(
      x = x0*cos(a) - y0*sin(a),
      y = x0*sin(a) + y0*cos(a)) %>% 
    select(n,x,y)
    
  return(layout)
}

# define coordinates systems for plots
coord_square <- coord_fixed(ratio = 1, expand = TRUE, xlim = c(-1, 1), ylim = c(-1, 1))
coord_ellipse <- coord_fixed(ratio = 1, expand = TRUE, xlim = c(-0.7, 0.7), ylim = c(-0.9, 0.9))   
  
# draw straight lines as relative neighborhood graph edges
render_glyph_graph_line <- function(data, width = 0.5, alpha=0.5) {
  
  graph <- as.data.frame(data) %>% select(x, y) %>% cccd::rng() %>% as_tbl_graph()
  
  graph %>%
    ggraph(layout = data) +
    geom_edge_link(edge_width = width, alpha = alpha) +
    geom_node_point(size = width * 1.5) +
    coord_square + theme_void()
}

# draw Bezier curves as relative neighborhood graph edges
render_glyph_graph_bezier <- function(data, width = 0.5, alpha=1, strength = 1) {
  
  graph <- as.data.frame(data) %>% select(x, y) %>% cccd::rng() %>% as_tbl_graph()
  
  graph %>%
    ggraph(layout = data) +
    geom_edge_diagonal(
      edge_width = width, alpha=alpha, strength = 1, n = 100,
      lineend = "round", linejoin = "round") +
    coord_ellipse + theme_void()
}

# draw a spline curve directly on layout points
render_glyph_spline <- function(data, width = 0.5, alpha=1, crop="ellipse") {
  
  plot <- data %>% 
    ggplot(aes(x, y)) +
    geom_bspline(lineend = "round", size = width, alpha = alpha) +
    theme_void()
  
  switch(crop,
         "none" = {plot},
         "square" = {plot + coord_square},
         "ellipse" = {plot + coord_ellipse})
}

# render a paragraph from an existing text and a set of characters
render_paragraph <- function(text, data, ncol=80, scale=0.9) {
  # split text to characters
  seq <- text %>% str_to_lower() %>% str_split(., "") 
  # map characters to glyph plots, non-match creates NULL plot (blank space with cowplot)
  data <- tibble(character=seq[[1]]) %>%
    left_join(data %>% select(character, pattern, plot)) 
  # render plots here to allow some variability in final layout ?
  plot_grid(plotlist = data$plot, ncol=ncol, scale=scale)
}

# layout_circle(n=5) %>% render_glyph(type="line")

```

```{r plot_constellations, eval=FALSE}
# generate a set of glyphs with a low number of control points
set.seed(1)
n_points = 10

data_glyphs <- tibble(pattern=1:100) %>% 
  mutate(
    layout = map(pattern, ~ layout_square(n = n_points)),
    plot = map(layout, render_glyph_graph_line)
  )

plot_glyphs <- plot_grid(plotlist = data_glyphs$plot, ncol=10, scale=0.6) + 
  theme(plot.margin = unit(c(1,1,1,1), "cm")) 

ggsave(
  plot_glyphs,
  file="./R/figures/graph_set_rng_line.png",
  dpi=300, width=210, height=210, scale=1, units="mm")

```

```{r plot_graph_glyphs, eval=FALSE}
# generate a set of glyphs with a low number of control points
set.seed(1)
n_points = 5

data_glyphs <- tibble(pattern=1:100) %>% 
  mutate(
    layout = map(pattern, ~ layout_ellipse(n = n_points)),
    plot = map(layout, render_glyph_graph_bezier)
  )

plot_glyphs <- plot_grid(plotlist = data_glyphs$plot, ncol=10, scale=0.8) + 
  theme(plot.margin = unit(c(1,1,1,1), "cm")) 

ggsave(
  plot_glyphs,
  file="./R/figures/graph_set_rng_glyphs.png",
  dpi=300, width=210, height=210, scale=1, units="mm")

```

```{r plot_spline_glyphs, eval=FALSE}
# generate original glyph type by using splines
# https://inconvergent.net/2017/spline-script/

set.seed(1)
n_points = 6

data_glyphs <- tibble(pattern=1:100) %>% 
  mutate(
    layout = map(pattern, ~ layout_ellipse(n = n_points)),
    plot = map(layout, render_glyph_spline)
  )

plot_glyphs <- plot_grid(plotlist = data_glyphs$plot, ncol=10, scale=0.8) + 
  theme(plot.margin = unit(c(1,1,1,1), "cm")) 

ggsave(
  plot_glyphs,
  file="./R/figures/graph_set_spline_glyphs.png",
  dpi=300, width=210, height=210, scale=1, units="mm")

```

```{r plot_spline_glyphs_variability, eval=FALSE}
# add glyph variability using random noise on layout coordinates
set.seed(3)
n_points = 6

data_glyphs <- tibble(pattern=1:100) %>% 
  mutate(
    layout = map(pattern, ~ layout_ellipse(n = n_points))
  ) %>%  
  slice_sample(n=10) %>% 
  crossing(r=1:10) %>% 
  mutate(
    layout_rng = map(
      layout,
      ~ unnest(.x, cols = c(x,y)) %>%
        mutate(across(x:y, jitter, amount=1/5))),
    plot = map(layout_rng, render_glyph_spline)
  ) 

plot_glyphs <- plot_grid(plotlist = data_glyphs$plot, ncol=10, scale=0.8) + 
  theme(plot.margin = unit(c(1,1,1,1), "cm")) 

ggsave(
  plot_glyphs,
  file="./R/figures/graph_set_spline_glyphs_variability.png",
  dpi=300, width=210, height=210, scale=1, units="mm")

```

```{r plot_spline_lipsum, eval=FALSE}
# map glyphs to letters and generate text to get glyphs sequence

# define a character map
set.seed(1)
n_points = 6

data_glyphs <- tibble(pattern=1:28) %>% 
  mutate(
    layout = map(pattern, ~ layout_ellipse(n = n_points)),
    plot = map(layout, render_glyph_spline, width=0.3, crop="ellipse")
  ) %>%
  mutate(character = c(letters[1:26], ".", ","))

# generate a nonsense text
set.seed(10)
seq_text <- stringi::stri_rand_lipsum(n=3)
seq_prop <- str_length(seq_text)/sum(str_length(seq_text))

data_text <- tibble(text=seq_text) %>% 
  mutate(plot = map(text, render_paragraph, data=data_glyphs, ncol=80, scale=1.6))

hash_md5 <- digest::digest(data_glyphs)
footer <- paste(Sys.Date(), substr(hash_md5, start = 1, stop = 7))

plot_text <- plot_grid(plotlist = data_text$plot, ncol=1, rel_heights=c(seq_prop)) +
  draw_label(footer, x=1, y=-0.15, hjust=1, size=6) +
  theme(plot.margin = unit(c(3,1,5,1), "cm")) 

ggsave(
  plot_text,
  file="./R/figures/graph_set_text_lipsum.png",
  dpi=300, width=295, height=210, scale=1, units="mm")

```


```{r plot_composite_glyphs, eval=FALSE}
# superpose simple glyphs

d <- layout_square(n = 5) 

```

```{r analysis_graph_cluster, eval=FALSE}
library(cluster)

# the aim is to cluster glyphs by layout distance to get medoids then add randomness
# sampling on cluster population gives too much variability
# glyphs generated from medoids are not variable enough

# generate a set of glyphs and add variability for each glyph
set.seed(1)
n_points = 5
n_cluster = 49

data_glyphs <- tibble(pattern=1:5000) %>% 
  mutate(
    layout = map(pattern, ~ layout_circle(n = n_points))
  )

matrix_layout <- data_glyphs %>% 
  select(pattern, layout) %>% unnest(layout) %>%
  pivot_wider(names_from = n, values_from = c(x, y)) %>% 
  select(-pattern) %>% as.matrix()

cluster_glyphs <- pam(matrix_layout, k = n_cluster, pamonce = 5)

data_medoids <- as_tibble(cluster_glyphs$medoids, rownames="pattern") %>% 
  pivot_longer(
    cols = -pattern,
    names_pattern = "(.)_(.)",
    names_to = c(".value", "n")
  ) %>% 
  group_nest(pattern, .key="layout") %>% 
  mutate(plot = map(layout, render_glyph_graph_bezier))
  
# plot a subset of glyphs in each cluster
plot_glyphs <- plot_grid(plotlist = data_medoids$plot, scale = 0.8) 

ggsave(
  plot_glyphs,
  file="./R/figures/graph_set_rng_glyphs_medoids.png",
  dpi=300, width=210, height=210, scale=1, units="mm")

```
