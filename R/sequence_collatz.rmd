# Explore the use of sequences to generate plant-like visualizations

```{r setup}
library(tidyverse)
library(ggforce)
library(furrr)
library(cowplot)

plan(multisession)

knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
options(dplyr.summarise.inform = FALSE)
options(future.rng.onMisuse = "ignore")

# functions
source("R/functions_sampling.r")
source("R/functions_geometry.r")
source("R/functions_sequence.r")

```

## Outline

A sequence of integers is generated from a set of rules (here, the Collatz [sequence](https://en.wikipedia.org/wiki/Collatz_conjecture)). Then, a curve is defined by mapping sequence elements to segment length, with a fixed angle between segments. Multiple curves are computed to constitute a node, and multiple nodes to constitute a stem. The only random elements are initial value for the sequence, and the angle between curve segments. These examples explore the :

* generation of a node defined as multiple curves and vertical shifting of their starting point by a fixed amount (plot_node_dense)
* generation of a few nodes with same attributes and simple geometric deformation.
* generation of a population of nodes with attributes (scale, shifting) and position as a function of a 2D grid. 
* generation of multiple node with attributes (number of leaves, scale, angle, position) varying as a function of position on a stem-like structure (plot_stem).

```{r plot_node_dense, eval=FALSE}
# plot a single node with dense polygons

p_seed = 5
p_node = 300
p_imax = 100
p_lmax = 3000
p_angle = 40
p_shift = 4
p_width = 10
p_shape = "spline"

# seeds 4, 8, 11
data_dense <- gen_node(
  n = p_node, imax = p_imax, lmax = p_lmax,
  amin = -p_angle, amax = p_angle, 
  shift = p_shift, width = p_width, seed = p_seed, shape=p_shape)

plot_dense <- data_dense %>%
  render_node(radius = 0, margin = 10,
    xlim = c(-100, 100), ylim = c(180,460))

file <- "collatz_dense_05"

ggsave(
  plot_dense, file = glue::glue("R/figures/sequence/{file}.png"),
  width=format$a4[1], height = format$a4[2],
  dpi=300, scale=1, units="mm", bg = "white")

ggsave(
  plot_dense, file = glue::glue("R/figures/sequence/svg/{file}.svg"),
  width=format$a4[1], height = format$a4[2],
  scale=1, units="mm", bg = "white")

glue::glue("vpype  read {file}_traced.svg  linesimplify filter --min-length 1mm  linemerge --tolerance 0.5mm  linesort  write {file}_plot.svg ")

```

```{r plot_mixture, eval=FALSE}
# plot n nodes with dense polygons

p_node = 4
p_leaf = 200
p_imax = 100
p_lmax = 3000
p_angle = 20
p_shift = 4
p_width = 5
p_shape = "spline"

# generate n nodes
set.seed(1)

data_plot <- tibble(node = 1:p_node) %>% 
  mutate(
    data = map(node, ~ gen_node(
      n = p_leaf, imax = p_imax, lmax = p_lmax, amin = -p_angle, amax = p_angle, 
      shift = p_shift, width = p_width, shape=p_shape))
    )

plot_dense <- data_plot %>%
  mutate(
    x0 = seq(0, by = 250, len=p_node),
    data_t = map2(data, x0, ~ r_t(..1, a = 0, x0 = ..2, y0 = 0))
    ) %>% 
  unnest(data_t) %>% 
  ggplot() + 
  geom_shape(
    aes(x,y, group = interaction(node, id)),
    color="black", fill="white",
    size = 0.5) +
  coord_cartesian(xlim =c(100, 600) , ylim=c(200, 500)) +
  theme_void() + theme(plot.margin = unit(rep(1,4), "cm"))


file <- "collatz_mixture_00"
   
ggsave(
  plot_dense, file = glue::glue("R/figures/sequence/{file}.png"),
  width=format$a4[1], height = format$a4[1],
  dpi=100, scale=1, units="mm", bg="white")

ggsave(
  plot_dense, file = glue::glue("R/figures/sequence/svg/{file}.svg"),
  width=format$a4[1], height = format$a4[1],
  scale=1, units="mm", bg="white")

glue::glue("vpype  read {file}_traced.svg linesimplify  filter --min-length 4mm  linemerge --tolerance 0.5mm  linesort  write {file}_plot.svg ")

```

```{r plot_population, eval=FALSE}
# plot a population of n nodes (2D distribution) with attributes varying with depth

p_seed = 2
p_node = 50
p_scale = 150
p_leaf = 10
p_imax = 50
p_lmax = 400
p_angle = 15
p_width = 8
p_shape = "spline"

# generate n nodes
set.seed(p_seed)

# set population parameters
data_population <- layout_square(n = p_node, method = "sobol", seed=p_seed) %>% 
  transmute(x0 = x * p_scale, y0 = y * p_scale) %>% arrange(y0) %>% 
  mutate(
    node = seq_len(p_node),
    shift = scales::rescale(y0, to=c(5, 2)),
    scale = scales::rescale(y0, to=c(1, 0.2))) 

# create nodes as a function of population parameters
data_node <- data_population %>% 
  mutate(
    data = future_pmap(
      list(shift, scale),
      ~ gen_node(
        n = p_leaf, imax = p_imax, lmax = p_lmax, amin = -p_angle, amax = p_angle, 
        shift = ..1, scale = ..2, width = p_width, shape = p_shape))
  )

# change position of nodes in 2D space
data_plot <- data_node %>%
  mutate(
    data_t = pmap(list(data, x0, y0), ~ r_t(..1, x0 = ..2, y0 = ..3, a = 0))
    ) %>% 
  select(node, data_t) %>% unnest(data_t)

plot_dense <- data_plot %>% 
  left_join(data_plot %>% distinct(node, id) %>% mutate(g = 1:n())) %>% 
  ggplot() + 
  geom_shape(
    aes(x,y, group = -g),
    color="black", fill="white", size = 0.5) +
  coord_cartesian(xlim =c(-200, 200) , ylim=c(0, 300)) +
  theme_void() + theme(plot.margin = unit(rep(1,4), "cm"))

file <- "collatz_population_00"
   
ggsave(
  plot_dense, file = glue::glue("R/figures/sequence/{file}.png"),
  width=format$a4[1], height = format$a4[1],
  dpi=300, scale=1, units="mm", bg = "white")

ggsave(
  plot_dense, file = glue::glue("R/figures/sequence/svg/{file}.svg"),
  width=format$a4[1], height = format$a4[1],
  scale=1, units="mm", bg = "white")

# post-process bitmap with a centerline tracing algorithm
glue::glue("vpype  read {file}_traced.svg  linesimplify  filter --min-length 1.5mm  linemerge --tolerance 0.5mm  linesort  write {file}_plot.svg ")

# use z-buffer algorithm on svg output
glue::glue("vpype  read {file}.svg  linesimplify filter --min-length 0.5mm  linemerge --tolerance 0.5mm  linesort occult write {file}_plot_occult.svg ")

```

```{r plot_density, eval=FALSE}
# plot a population of n nodes (2D distribution) with attributes varying with depth and node density

p_seed = 1
p_node = 100  # number of nodes (individuals)
p_scale = 200 # scale parameter for individuals
p_persp = 0.5 # adjust y axis for perspective
p_leaf = 15   # number of organ for each individual
p_imax = 50
p_lmax = 300
p_angle = 10
p_width = 10
p_shape = "polygon_lm"

# generate n nodes
set.seed(p_seed)

# draw a random layout for nodes
data_layout <-  layout_square(n = p_node) %>% 
  transmute(x0 = x * p_scale, y0 = y * p_scale) %>% arrange(y0) 

# count neighbor number in a given radius
matrix_distance <- data_layout %>%
  sf::st_as_sf(coords = c("x0", "y0")) %>% sf::st_distance()

# set population parameters : shift = f(density), scale = f(distance)
data_population <- data_layout %>% 
  mutate(
    node = seq_len(p_node),
    n = apply(matrix_distance, 1, function(x) {sum(x < 50) - 1}),
    shift = scales::rescale(n, to=c(1, 40)),
    scale = scales::rescale(y0, to=c(0.6, 0.1))) %>% 
  mutate(y0 = y0 * scales::rescale(y0, to=c(1, p_persp)))

# data_population %>% ggplot(aes(x0, y0, color = shift)) + geom_point() + coord_fixed()

# create nodes as a function of population parameters
data_node <- data_population %>% 
  mutate(
    data = future_pmap(
      list(shift, scale),
      ~ gen_node(
        n = p_leaf, imax = p_imax, lmax = p_lmax, amin = -p_angle, amax = p_angle, 
        shift = ..1, scale = ..2, width = p_width, shape = p_shape))
  )

# set node geometry in 2D space
data_plot <- data_node %>%
  mutate(
    data_t = pmap(list(data, x0, y0), ~ r_t(..1, x0 = ..2, y0 = ..3, a = 0))
    ) %>% 
  select(node, data_t) %>% unnest(data_t)

plot_dense <- data_plot %>% 
  left_join(data_plot %>% distinct(node, id) %>% mutate(g = 1:n())) %>% 
  ggplot() + 
  geom_shape(
    aes(x,y, group = -g),
    color="black", fill="white", size = 0.3) +
  coord_cartesian(xlim =c(-150, 150) , ylim=c(-100, 150)) +
  theme_void() + theme(plot.margin = unit(rep(1,4), "cm"))

file <- "collatz_density_00"
   
ggsave(
  plot_dense, file = glue::glue("R/figures/sequence/{file}.png"),
  width=format$a4[1], height = format$a4[1],
  dpi=300, scale=1, units="mm", bg = "white")

ggsave(
  plot_dense, file = glue::glue("R/figures/sequence/svg/{file}.png"),
  width=format$a4[1], height = format$a4[1],
  scale=1, units="mm", bg = "white")

glue::glue("vpype  read {file}_traced.svg  linesimplify  filter --min-length 4mm  linemerge --tolerance 0.5mm  linesort  write {file}_plot.svg ")

```

```{r plot_stem, eval=FALSE}

set.seed(1)

p_stem = 73 # starting point for the stem sequence
p_stem_angle = 10 # angle between successive stem segments
p_node = 35 # node number in the branch
p_node_angle = c(140, 10) # mean and sd of angle between nodes and stem
p_scale = 0.5 # stem scale

# set node parameters along the stem
data_topology <- tibble(
  node = seq_len(p_node),
  leaf = seq(15, 10, len = p_node),
  angle = seq(10, 5, len = p_node),
  lmax = seq(700, 400, len = p_node),
  scale = seq(1.2, 0.3, len = p_node)
  )

# generate nodes as a function of parameter list
data_node <- data_topology %>% 
  mutate(
    data = future_pmap(
      list(leaf, angle, lmax, scale),
      ~ gen_node(
        n = ..1, amin = -..2, amax = ..2, lmax = ..3, scale = ..4,
        width = 20))
    )

# generate stem geometry and node transformation parameters
data_stem <- gen_leaf(p_stem, a=p_stem_angle) %>% slice(1:p_node) %>% 
  mutate(across(x:yend, ~ . * p_scale)) %>% 
  mutate(
    n = rev(n),
    a = seq_alt(n=p_node, m=p_node_angle[1], sd=p_node_angle[2]),
    a = (a + angle) * pi/180) 

# merge stem and node data
data_plot <- data_node %>% 
  left_join(data_stem %>% select(node=n, x0=x, y0=y, a)) %>% 
  mutate(data_t = pmap(list(data, x0, y0, a), ~ r_t(..1, ..2, ..3, ..4)))

# plot
p <- ggplot() +
  geom_shape(
    data = data_stem %>% transform_path(width = 15),
    aes(x, y), alpha=0.2, size=1,
    radius = unit(2.5, 'pt'), expand = unit(2.5, 'pt'), 
    fill="white", color="black") +
  geom_path(data = data_stem, aes(x=x,y=y), color="black", size = 0.5) +
  geom_shape(
    data = data_plot %>% unnest(data_t),
    aes(x,y, group = interaction(node, id)),
    color="black", fill="white", size = 0.5) + 
  coord_fixed() + theme_void()


# export
file <- "collatz_stem_01"

ggsave(
  p, file = glue::glue("R/figures/sequence/{file}.png"),
  width=format$a4[2], height = format$a4[1],
  dpi=400, scale=1, units="mm", bg = "white")

ggsave(
  p, file = glue::glue("R/figures/sequence/svg/{file}.svg"),
  width=format$a4[2], height = format$a4[1],
  scale=1, units="mm")

# post-process bitmap with a centerline tracing algorithm
glue::glue("vpype  read {file}_traced.svg  linesimplify filter --min-length 1mm  linemerge --tolerance 0.5mm  linesort  write {file}_plot.svg ")

# use z-buffer algorithm on svg output
glue::glue("vpype  read {file}.svg  linesimplify filter --min-length 0.5mm  linemerge --tolerance 0.5mm  linesort occult write {file}_plot_occult.svg ")


```




